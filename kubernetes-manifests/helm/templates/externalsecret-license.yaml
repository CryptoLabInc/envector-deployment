{{- /* Creates ExternalSecret for the license token when External Secrets Operator is enabled */ -}}
{{- if and .Values.externalSecrets.enabled .Values.es2c.license.enabled (ne (.Values.externalSecrets.license.remoteRef.key | default "") "") }}
{{- $defaultSecretName := printf "%s-es2c-license" (include "es2-chart.fullname" .) -}}
{{- $secretName := (default $defaultSecretName .Values.externalSecrets.license.name) -}}
{{- $storeName := required "externalSecrets.license.secretStoreRef.name or externalSecrets.secretStoreRef.name is required when externalSecrets.enabled=true" (coalesce .Values.externalSecrets.license.secretStoreRef.name .Values.externalSecrets.secretStoreRef.name) -}}
{{- $storeKind := default "ClusterSecretStore" (coalesce .Values.externalSecrets.license.secretStoreRef.kind .Values.externalSecrets.secretStoreRef.kind) -}}
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: {{ $secretName }}
  labels:
    app: {{ include "es2-chart.fullname" . }}
    component: eso-license
spec:
  refreshInterval: {{ .Values.externalSecrets.license.refreshInterval | default "1m" | quote }}
  secretStoreRef:
    name: {{ $storeName | quote }}
    kind: {{ $storeKind | quote }}
  target:
    name: {{ $secretName }}
    creationPolicy: Owner
  data:
    - secretKey: {{ .Values.externalSecrets.license.secretKey | default "token.jwt" | quote }}
      remoteRef:
        key: {{ .Values.externalSecrets.license.remoteRef.key | quote }}
        {{- if .Values.externalSecrets.license.remoteRef.property }}
        property: {{ .Values.externalSecrets.license.remoteRef.property | quote }}
        {{- end }}
        {{- if .Values.externalSecrets.license.remoteRef.version }}
        version: {{ .Values.externalSecrets.license.remoteRef.version | quote }}
        {{- end }}
        {{- if .Values.externalSecrets.license.remoteRef.decodingStrategy }}
        decodingStrategy: {{ .Values.externalSecrets.license.remoteRef.decodingStrategy | quote }}
        {{- end }}
        {{- if .Values.externalSecrets.license.remoteRef.metadataPolicy }}
        metadataPolicy: {{ .Values.externalSecrets.license.remoteRef.metadataPolicy | quote }}
        {{- end }}
{{- end }}
